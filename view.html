<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bubble Tea — Live Orders</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .done-btn {
      background: #ff4747;
      border: none;
      border-radius: 6px;
      color: white;
      padding: 6px 10px;
      cursor: pointer;
      margin-top: 8px;
      font-size: 13px;
      align-self: flex-end;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .tabs button {
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
      background: #ddd;
    }
    .tabs button.active {
      background: #1f7aef;
      color: #fff;
    }

    .delete-all {
      background: #c0392b;
      border: none;
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 8px;
    }

    /* Order cards */
    .order-item {
      list-style: none;
      margin: 8px 0;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f8f9fb;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 4px;
    }
    .customer-name {
      font-size: 16px;
    }
    .order-meta {
      font-size: 11px;
      color: #777;
      white-space: nowrap;
    }
    .order-body {
      display: grid;
      grid-template-columns: auto 1fr;
      row-gap: 2px;
      column-gap: 8px;
      font-size: 13px;
    }
    .order-row-label {
      font-weight: 600;
      color: #333;
      text-align: right;
    }
    .order-row-value {
      color: #444;
    }

    /* Archive dropdown (accordion) style */
    .archive-group {
      list-style: none;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #eee;
      padding: 0;
      overflow: hidden;
      background: #fafafa;
    }
    .archive-header {
      width: 100%;
      text-align: left;
      background: #f2f2f2;
      border: none;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .archive-header span.label {
      flex: 1;
    }
    .archive-header span.chevron {
      margin-left: 8px;
      font-size: 12px;
    }
    .archive-orders {
      list-style: none;
      margin: 0;
      padding: 6px 10px 8px 10px;
    }

    #staffSection ul {
      list-style: none;
      padding-left: 0;
    }
    #staffSection li {
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <h2>Bubble Tea — Orders Dashboard</h2>
    <div>
      <span id="who"></span>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <main class="card">
    <div class="tabs">
      <button id="activeTab" class="active">Active Orders</button>
      <button id="archiveTab">Archive</button>
    </div>

    <!-- Owners-only money totals for TODAY (active orders view) -->
    <section id="totalsSection" style="display:none;">
      <h3>Today's totals (owners only)</h3>
      <p>Cash: <strong id="cashTotal">0</strong> AMD</p>
      <p>Card: <strong id="cardTotal">0</strong> AMD</p>
      <p>Total: <strong id="totalToday">0</strong> AMD</p>
    </section>

    <hr />

    <section>
      <h3 id="listTitle">Live orders</h3>
      <button id="deleteAllBtn" class="delete-all" style="display:none;">Delete All</button>
      <ul id="ordersList"></ul>
    </section>

    <!-- Owners-only: manage staff roles -->
    <section id="staffSection" style="display:none; margin-top:20px;">
      <h3>Staff roles (owners only)</h3>
      <form id="addStaffForm">
        <label>Staff email
          <input id="staffEmail" type="email" required />
        </label>
        <label>Role
          <select id="staffRole">
            <option value="viewer">Viewer (bar staff – see orders)</option>
            <option value="order">Order taker (front – enters orders)</option>
          </select>
        </label>
        <button type="submit">Add / update staff role</button>
      </form>

      <h4>Current staff</h4>
      <ul id="staffList"></ul>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>

  <script>
    const OWNER_EMAILS = [
      "b.sargsyan@student.uwcdilijan.am",
      "e.mosoian@student.uwcdilijan.am"
    ];

    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentView = "active";
    let unsubscribeListener = null;
    let isOwner = false;

    // Cleaner labels (no colors in text)
    const BUBBLE_LABELS = {
      mango: "Mango bubbles",
      peach: "Peach bubbles",
      passion_fruit: "Passion fruit bubbles",
      lychee: "Lychee bubbles",
      pomegranate: "Pomegranate bubbles"
    };

    const SYRUP_LABELS = {
      mango: "Mango syrup",
      peach: "Peach syrup",
      passion_fruit: "Passion fruit syrup",
      strawberry: "Strawberry syrup",
      pomegranate: "Pomegranate syrup"
    };

    const TEA_LABELS = {
      green: "Green tea",
      black: "Black tea"
    };

    function buildOrderCardHtml(o, ts) {
      const bubbles = BUBBLE_LABELS[o.bubbles] || o.bubbles;
      const syrup = SYRUP_LABELS[o.syrup] || o.syrup;
      const tea   = TEA_LABELS[o.tea] || o.tea;

      const payment =
        o.payment === "cash" ? "Cash" :
        o.payment === "card" ? "Card" :
        (o.payment || "");

      const lines = [
        { label: "Bubbles", value: bubbles },
        { label: "Syrup",   value: syrup },
        { label: "Tea",     value: tea }
      ];

      // Only owners see payment + price
      if (isOwner) {
        lines.push({ label: "Payment", value: payment });
        lines.push({ label: "Price",   value: (o.price || 0) + " AMD" });
      }

      const bodyHtml = lines.map(l => `
        <div class="order-row-label">${l.label}</div>
        <div class="order-row-value">${l.value}</div>
      `).join("");

      return `
        <div class="order-header">
          <strong class="customer-name">${o.customer}</strong>
          <span class="order-meta">By ${o.createdBy} at ${ts.toLocaleString()}</span>
        </div>
        <div class="order-body">
          ${bodyHtml}
        </div>
      `;
    }

    function renderOrders(snapshot) {
      const list = document.getElementById("ordersList");
      list.innerHTML = "";

      if (currentView === "active") {
        let cashTotal = 0;
        let cardTotal = 0;

        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);

        snapshot.forEach(doc => {
          const o = doc.data();
          const ts = o.createdAt ? o.createdAt.toDate() : new Date();

          const li = document.createElement("li");
          li.className = "order-item";
          li.innerHTML = buildOrderCardHtml(o, ts);

          const btn = document.createElement("button");
          btn.textContent = "Done";
          btn.className = "done-btn";
          btn.onclick = () => markAsDone(doc.id, o);

          li.appendChild(btn);
          list.appendChild(li);

          if (isOwner && ts >= start && ts < end) {
            const price = Number(o.price || 0);
            if (o.payment === "cash") cashTotal += price;
            else if (o.payment === "card") cardTotal += price;
          }
        });

        if (isOwner) {
          document.getElementById("cashTotal").textContent = cashTotal;
          document.getElementById("cardTotal").textContent = cardTotal;
          document.getElementById("totalToday").textContent = cashTotal + cardTotal;
        }
      }

      if (currentView === "archive") {
        const groups = {};

        snapshot.forEach(doc => {
          const o = doc.data();
          const ts = o.finishedAt
            ? o.finishedAt.toDate()
            : (o.createdAt ? o.createdAt.toDate() : new Date());

          const key = ts.toISOString().slice(0, 10); // YYYY-MM-DD

          if (!groups[key]) {
            groups[key] = { date: ts, orders: [] };
          }
          groups[key].orders.push({ id: doc.id, data: o, ts });
        });

        const todayKey = new Date().toISOString().slice(0, 10);

        const dateKeys = Object.keys(groups).sort((a, b) => new Date(b) - new Date(a));

        dateKeys.forEach(key => {
          const group = groups[key];
          const date = group.date;
          const dateLabel = date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric"
          });

          let dayTotal = 0;
          group.orders.forEach(entry => {
            dayTotal += Number(entry.data.price || 0);
          });

          const isTodayGroup = key === todayKey;

          const groupLi = document.createElement("li");
          groupLi.className = "archive-group";

          const headerBtn = document.createElement("button");
          headerBtn.type = "button";
          headerBtn.className = "archive-header";

          const labelSpan = document.createElement("span");
          labelSpan.className = "label";

          if (isOwner) {
            labelSpan.textContent = `${dateLabel} — Total: ${dayTotal} AMD`;
          } else {
            labelSpan.textContent = dateLabel;
          }

          const chevronSpan = document.createElement("span");
          chevronSpan.className = "chevron";
          chevronSpan.textContent = isTodayGroup ? "▲" : "▼";

          headerBtn.appendChild(labelSpan);
          headerBtn.appendChild(chevronSpan);

          const innerUl = document.createElement("ul");
          innerUl.className = "archive-orders";
          innerUl.style.display = isTodayGroup ? "block" : "none";

          group.orders
            // NEWEST first inside each day
            .sort((a, b) => b.ts - a.ts)
            .forEach(entry => {
              const o = entry.data;
              const orderLi = document.createElement("li");
              orderLi.className = "order-item";
              orderLi.innerHTML = buildOrderCardHtml(o, entry.ts);

              if (isOwner) {
                const delBtn = document.createElement("button");
                delBtn.textContent = "Delete";
                delBtn.className = "done-btn";
                delBtn.style.background = "#7f8c8d";
                delBtn.onclick = () => deleteArchiveOrder(entry.id);
                orderLi.appendChild(delBtn);
              }

              innerUl.appendChild(orderLi);
            });

          headerBtn.addEventListener("click", () => {
            const isHidden = innerUl.style.display === "none";
            innerUl.style.display = isHidden ? "block" : "none";
            chevronSpan.textContent = isHidden ? "▲" : "▼";
          });

          groupLi.appendChild(headerBtn);
          groupLi.appendChild(innerUl);
          list.appendChild(groupLi);
        });
      }
    }

    async function markAsDone(orderId, orderData) {
      try {
        await db.collection("archive").add({
          ...orderData,
          finishedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection("orders").doc(orderId).delete();
      } catch (err) {
        console.error("Error archiving order:", err);
        alert("Could not move order to archive.");
      }
    }

    async function deleteAllArchive() {
      if (!isOwner) {
        alert("Only owners can delete all archived orders.");
        return;
      }
      if (!confirm("Are you sure you want to delete ALL archived orders?")) return;

      try {
        const snap = await db.collection("archive").get();
        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        alert("All archived orders deleted.");
      } catch (err) {
        alert("Failed to delete: " + err.message);
      }
    }

    async function deleteArchiveOrder(id) {
      if (!isOwner) {
        alert("Only owners can delete archived orders.");
        return;
      }
      if (!confirm("Delete this archived order?")) return;

      try {
        await db.collection("archive").doc(id).delete();
      } catch (err) {
        alert("Failed to delete order: " + err.message);
      }
    }

    function listenToCollection() {
      if (unsubscribeListener) unsubscribeListener();
      const collectionName = currentView === "active" ? "orders" : "archive";

      document.getElementById("listTitle").textContent =
        currentView === "active" ? "Live orders" : "Archived orders";

      document.getElementById("deleteAllBtn").style.display =
        currentView === "archive" && isOwner ? "inline-block" : "none";

      let query = db.collection(collectionName).orderBy("createdAt", "asc");

      unsubscribeListener = query.onSnapshot(renderOrders, err => {
        console.error("listen error", err);
      });
    }

    function setupStaffManagement() {
      const staffSection = document.getElementById("staffSection");
      const addForm = document.getElementById("addStaffForm");
      const staffList = document.getElementById("staffList");

      addForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("staffEmail").value.trim().toLowerCase();
        const role = document.getElementById("staffRole").value;
        if (!email) return;

        try {
          await db.collection("staff").doc(email).set({ email, role });
          document.getElementById("staffEmail").value = "";
          alert("Staff role added/updated.");
        } catch (err) {
          alert(err.message);
        }
      });

      db.collection("staff").orderBy("email").onSnapshot(snap => {
        staffList.innerHTML = "";
        snap.forEach(doc => {
          const data = doc.data();
          const email = data.email || doc.id;
          const role = data.role || "viewer";

          const li = document.createElement("li");
          li.textContent = `${email} — ${role}`;

          if (!OWNER_EMAILS.includes(email)) {
            const delBtn = document.createElement("button");
            delBtn.textContent = "Remove";
            delBtn.className = "done-btn";
            delBtn.style.background = "#7f8c8d";
            delBtn.onclick = () => deleteStaff(email);
            li.appendChild(delBtn);
          }

          staffList.appendChild(li);
        });
      });

      if (isOwner && currentView === "active") {
        staffSection.style.display = "block";
      }
    }

    async function deleteStaff(email) {
      if (!confirm(`Remove ${email} from staff?`)) return;
      try {
        await db.collection("staff").doc(email).delete();
      } catch (err) {
        alert(err.message);
      }
    }

    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location = "index.html";
        return;
      }

      const email = user.email.toLowerCase();
      document.getElementById("who").textContent = email;
      isOwner = OWNER_EMAILS.includes(email);

      if (!isOwner) {
        try {
          const doc = await db.collection("staff").doc(email).get();
          if (!doc.exists) {
            await auth.signOut();
            window.location = "index.html";
            return;
          }
          const role = doc.data().role;

          // Only viewer role is allowed here; order takers go to order page
          if (role !== "viewer") {
            window.location = "order.html";
            return;
          }
        } catch (err) {
          console.error(err);
          await auth.signOut();
          window.location = "index.html";
          return;
        }
      } else {
        document.getElementById("totalsSection").style.display = "block";
        setupStaffManagement();
        if (currentView === "active") {
          document.getElementById("staffSection").style.display = "block";
        }
      }

      listenToCollection();
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => window.location = "index.html");
    });

    document.getElementById("activeTab").addEventListener("click", () => {
      currentView = "active";
      document.getElementById("activeTab").classList.add("active");
      document.getElementById("archiveTab").classList.remove("active");
      if (isOwner) {
        document.getElementById("totalsSection").style.display = "block";
        document.getElementById("staffSection").style.display = "block";
      }
      listenToCollection();
    });

    document.getElementById("archiveTab").addEventListener("click", () => {
      currentView = "archive";
      document.getElementById("archiveTab").classList.add("active");
      document.getElementById("activeTab").classList.remove("active");
      document.getElementById("totalsSection").style.display = "none";
      document.getElementById("staffSection").style.display = "none";
      listenToCollection();
    });

    document.getElementById("deleteAllBtn").addEventListener("click", deleteAllArchive);
  </script>
</body>
</html>
