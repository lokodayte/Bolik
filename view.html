<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bubble Tea — Live Orders</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .done-btn {
      background: #ff4747;
      border: none;
      border-radius: 6px;
      color: white;
      padding: 6px 10px;
      cursor: pointer;
      margin-top: 6px;
      margin-left: 4px;
      font-size: 13px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .tabs button {
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
      background: #ddd;
    }
    .tabs button.active {
      background: #1f7aef;
      color: #fff;
    }
    .delete-all {
      background: #c0392b;
      border: none;
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 8px;
    }
    /* Archive dropdown (accordion) style */
    .archive-group {
      list-style: none;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #eee;
      padding: 0;
      overflow: hidden;
      background: #fafafa;
    }
    .archive-header {
      width: 100%;
      text-align: left;
      background: #f2f2f2;
      border: none;
      padding: 8px 10px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .archive-header span.label {
      flex: 1;
    }
    .archive-header span.chevron {
      margin-left: 8px;
      font-size: 12px;
    }
    .archive-orders {
      list-style: none;
      margin: 0;
      padding: 6px 10px 8px 20px;
    }
    #staffSection ul {
      list-style: none;
      padding-left: 0;
    }
    #staffSection li {
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <h2>Bubble Tea — Orders Dashboard</h2>
    <div>
      <span id="who"></span>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <main class="card">
    <div class="tabs">
      <button id="activeTab" class="active">Active Orders</button>
      <button id="archiveTab">Archive</button>
    </div>

    <!-- Owners-only money totals for TODAY (active orders view) -->
    <section id="totalsSection" style="display:none;">
      <h3>Today's totals (owners only)</h3>
      <p>Cash: <strong id="cashTotal">0</strong> AMD</p>
      <p>Card: <strong id="cardTotal">0</strong> AMD</p>
      <p>Total: <strong id="totalToday">0</strong> AMD</p>
    </section>

    <hr />

    <section>
      <h3 id="listTitle">Live orders</h3>
      <button id="deleteAllBtn" class="delete-all" style="display:none;">Delete All</button>
      <ul id="ordersList"></ul>
    </section>

    <!-- Owners-only: manage staff roles + create staff accounts -->
    <section id="staffSection" style="display:none; margin-top:20px;">
      <h3>Create staff login (owners only)</h3>
      <p class="muted">This creates a Firebase login and adds them to staff in one step.</p>
      <form id="createStaffAccountForm">
        <label>Staff email
          <input id="createStaffEmail" type="email" required />
        </label>
        <label>Temporary password
          <input id="createStaffPassword" type="password" required />
        </label>
        <label>Role
          <select id="createStaffRole">
            <option value="viewer">Viewer (bar staff – see orders)</option>
            <option value="order">Order taker (front – enters orders)</option>
          </select>
        </label>
        (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/view.html b/view.html
index 863e7c43c03b1a3219eddd26a6b0e7aa24a3434c..f0fc74db6ae11dda192b2912d17638bb9d04b471 100644
--- a/view.html
+++ b/view.html
@@ -137,66 +137,161 @@
         <button type="submit">Create staff account</button>
       </form>
 
       <hr />
 
       <h3>Staff roles (change role only)</h3>
       <form id="addStaffForm">
         <label>Staff email
           <input id="staffEmail" type="email" required />
         </label>
         <label>Role
           <select id="staffRole">
             <option value="viewer">Viewer (bar staff – see orders)</option>
             <option value="order">Order taker (front – enters orders)</option>
           </select>
         </label>
         <button type="submit">Add / update staff role</button>
       </form>
 
       <h4>Current staff</h4>
       <ul id="staffList"></ul>
     </section>
   </main>
 
   <!-- Firebase -->
+  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.9.0/sql-wasm.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
   <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
   <script src="firebase.js"></script>
 
   <script>
     const OWNER_EMAILS = [
       "b.sargsyan@student.uwcdilijan.am",
       "e.mosoian@student.uwcdilijan.am"
     ];
 
     const auth = firebase.auth();
     const db = firebase.firestore();
     const functions = firebase.functions();
 
+    // Lightweight SQLite store (sql.js) to keep a local record of staff accounts
+    const STAFF_SQL_STORAGE_KEY = "staffSqlDb";
+    const staffDbPromise = (async () => {
+      if (typeof initSqlJs === "undefined") {
+        console.warn("sql.js not loaded; local staff archive disabled");
+        return null;
+      }
+
+      const SQL = await initSqlJs({
+        locateFile: (file) => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.9.0/${file}`
+      });
+
+      const db = loadDbFromStorage(SQL);
+      db.run(
+        "CREATE TABLE IF NOT EXISTS staff_accounts (" +
+          "email TEXT PRIMARY KEY, " +
+          "password TEXT, " +
+          "role TEXT, " +
+          "created_at TEXT" +
+        ")"
+      );
+
+      return db;
+    })();
+
+    function base64ToUint8Array(b64) {
+      const binary = atob(b64);
+      const bytes = new Uint8Array(binary.length);
+      for (let i = 0; i < binary.length; i++) {
+        bytes[i] = binary.charCodeAt(i);
+      }
+      return bytes;
+    }
+
+    function dbToBase64(db) {
+      const data = db.export();
+      let binary = "";
+      data.forEach((byte) => {
+        binary += String.fromCharCode(byte);
+      });
+      return btoa(binary);
+    }
+
+    function loadDbFromStorage(SQL) {
+      const saved = localStorage.getItem(STAFF_SQL_STORAGE_KEY);
+      if (!saved) return new SQL.Database();
+      try {
+        return new SQL.Database(base64ToUint8Array(saved));
+      } catch (err) {
+        console.warn("Failed to restore staff SQL DB, creating new one", err);
+        return new SQL.Database();
+      }
+    }
+
+    async function persistStaffDb() {
+      try {
+        const dbInstance = await staffDbPromise;
+        if (!dbInstance) return;
+        const b64 = dbToBase64(dbInstance);
+        localStorage.setItem(STAFF_SQL_STORAGE_KEY, b64);
+      } catch (err) {
+        console.warn("Unable to persist staff SQL DB", err);
+      }
+    }
+
+    async function saveStaffAccountToSql(email, password, role) {
+      const dbInstance = await staffDbPromise;
+      if (!dbInstance) return;
+
+      dbInstance.run(
+        "INSERT OR REPLACE INTO staff_accounts (email, password, role, created_at) VALUES (?, ?, ?, datetime('now'))",
+        [email, password, role]
+      );
+      await persistStaffDb();
+    }
+
+    async function upsertStaffRoleInSql(email, role) {
+      const dbInstance = await staffDbPromise;
+      if (!dbInstance) return;
+
+      let existingPassword = "";
+      const stmt = dbInstance.prepare("SELECT password FROM staff_accounts WHERE email = ?", [email]);
+      if (stmt.step()) {
+        existingPassword = stmt.get()[0] || "";
+      }
+      stmt.free();
+
+      dbInstance.run(
+        "INSERT OR REPLACE INTO staff_accounts (email, password, role, created_at) VALUES (?, ?, ?, datetime('now'))",
+        [email, existingPassword, role]
+      );
+      await persistStaffDb();
+    }
+
     let currentView = "active";
     let unsubscribeListener = null;
     let isOwner = false;
 
     // More understandable labels for new staff
     const BUBBLE_LABELS = {
       mango: "Mango bubbles (yellow)",
       peach: "Peach bubbles (orange)",
       passion_fruit: "Passion fruit bubbles",
       lychee: "Lychee bubbles",
       pomegranate: "Pomegranate bubbles (red)"
     };
 
     const SYRUP_LABELS = {
       mango: "Mango syrup",
       peach: "Peach syrup",
       passion_fruit: "Passion fruit syrup",
       strawberry: "Strawberry syrup",
       pomegranate: "Pomegranate syrup"
     };
 
     const TEA_LABELS = {
       green: "Green tea",
       black: "Black tea"
     };
@@ -405,97 +500,104 @@
     async function deleteArchiveOrder(id) {
       if (!isOwner) {
         alert("Only owners can delete archived orders.");
         return;
       }
       if (!confirm("Delete this archived order?")) return;
 
       try {
         await db.collection("archive").doc(id).delete();
       } catch (err) {
         alert("Failed to delete order: " + err.message);
       }
     }
 
     function listenToCollection() {
       if (unsubscribeListener) unsubscribeListener();
       const collectionName = currentView === "active" ? "orders" : "archive";
 
       document.getElementById("listTitle").textContent =
         currentView === "active" ? "Live orders" : "Archived orders";
 
       document.getElementById("deleteAllBtn").style.display =
         currentView === "archive" && isOwner ? "inline-block" : "none";
 
       // Oldest orders first in both collections (we change layout in archive)
-      let query = db.collection(collectionName).orderBy("createdAt", "asc");
+      let query = db.collection(collectionName);
+      if (collectionName === "archive") {
+        query = query.orderBy("finishedAt", "asc");
+      } else {
+        query = query.orderBy("createdAt", "asc");
+      }
 
       unsubscribeListener = query.onSnapshot(renderOrders, err => {
         console.error("listen error", err);
       });
     }
 
     function setupStaffManagement() {
       const staffSection = document.getElementById("staffSection");
       const createForm = document.getElementById("createStaffAccountForm");
       const addForm = document.getElementById("addStaffForm");
       const staffList = document.getElementById("staffList");
 
       // Cloud Function: create Auth user + staff doc
       const createStaffUserFn = functions.httpsCallable("createStaffUser");
 
       createForm.addEventListener("submit", async (e) => {
         e.preventDefault();
         const email = document.getElementById("createStaffEmail").value.trim().toLowerCase();
         const password = document.getElementById("createStaffPassword").value;
         const role = document.getElementById("createStaffRole").value;
 
         if (!email || !password) {
           alert("Email and password are required.");
           return;
         }
 
         try {
           await createStaffUserFn({ email, password, role });
+          await saveStaffAccountToSql(email, password, role);
           document.getElementById("createStaffEmail").value = "";
           document.getElementById("createStaffPassword").value = "";
           alert("Staff account created successfully.");
         } catch (err) {
           console.error(err);
           alert("Failed to create staff user: " + (err.message || err));
         }
       });
 
       // Change role only (or add staff doc if already created manually)
       addForm.addEventListener("submit", async (e) => {
         e.preventDefault();
         const email = document.getElementById("staffEmail").value.trim().toLowerCase();
         const role = document.getElementById("staffRole").value;
         if (!email) return;
 
         try {
           await db.collection("staff").doc(email).set({ email, role });
+          await upsertStaffRoleInSql(email, role);
           document.getElementById("staffEmail").value = "";
           alert("Staff role added/updated.");
         } catch (err) {
           alert(err.message);
         }
       });
 
       // Live list of staff
       db.collection("staff").orderBy("email").onSnapshot(snap => {
         staffList.innerHTML = "";
         snap.forEach(doc => {
           const data = doc.data();
           const email = data.email || doc.id;
           const role = data.role || "viewer";
 
           const li = document.createElement("li");
           li.textContent = `${email} — ${role}`;
 
           // Do not remove owners from here
           if (!OWNER_EMAILS.includes(email)) {
             const delBtn = document.createElement("button");
             delBtn.textContent = "Remove";
             delBtn.className = "done-btn";
             delBtn.style.background = "#7f8c8d";
             delBtn.onclick = () => deleteStaff(email);
 
EOF
)
        snap.forEach(doc => {
          const data = doc.data();
          const email = data.email || doc.id;
          const role = data.role || "viewer";

          const li = document.createElement("li");
          li.textContent = `${email} — ${role}`;

          // Do not remove owners from here
          if (!OWNER_EMAILS.includes(email)) {
            const delBtn = document.createElement("button");
            delBtn.textContent = "Remove";
            delBtn.className = "done-btn";
            delBtn.style.background = "#7f8c8d";
            delBtn.onclick = () => deleteStaff(email);
            li.appendChild(delBtn);
          }

          staffList.appendChild(li);
        });
      });

      // Initially visible only if owner and on Active tab
      if (isOwner && currentView === "active") {
        staffSection.style.display = "block";
      }
    }

    async function deleteStaff(email) {
      if (!confirm(`Remove ${email} from staff?`)) return;
      try {
        await db.collection("staff").doc(email).delete();
      } catch (err) {
        alert(err.message);
      }
    }

    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location = "index.html";
        return;
      }

      const email = user.email.toLowerCase();
      document.getElementById("who").textContent = email;
      isOwner = OWNER_EMAILS.includes(email);

      if (!isOwner) {
        try {
          const doc = await db.collection("staff").doc(email).get();
          if (!doc.exists) {
            await auth.signOut();
            window.location = "index.html";
            return;
          }
          const role = doc.data().role;

          // Only viewer role is allowed here
          if (role !== "viewer") {
            window.location = "order.html";
            return;
          }
        } catch (err) {
          console.error(err);
          await auth.signOut();
          window.location = "index.html";
          return;
        }
      } else {
        // Owner: show totals and staff management (on active tab only)
        document.getElementById("totalsSection").style.display = "block";
        setupStaffManagement();
        if (currentView === "active") {
          document.getElementById("staffSection").style.display = "block";
        }
      }

      listenToCollection();
    });

    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut().then(() => window.location = "index.html");
    });

    document.getElementById("activeTab").addEventListener("click", () => {
      currentView = "active";
      document.getElementById("activeTab").classList.add("active");
      document.getElementById("archiveTab").classList.remove("active");
      if (isOwner) {
        document.getElementById("totalsSection").style.display = "block";
        document.getElementById("staffSection").style.display = "block";
      }
      listenToCollection();
    });

    document.getElementById("archiveTab").addEventListener("click", () => {
      currentView = "archive";
      document.getElementById("archiveTab").classList.add("active");
      document.getElementById("activeTab").classList.remove("active");
      document.getElementById("totalsSection").style.display = "none";
      // HIDE staff panel on archive like you wanted
      document.getElementById("staffSection").style.display = "none";
      listenToCollection();
    });

    document.getElementById("deleteAllBtn").addEventListener("click", deleteAllArchive);
  </script>
</body>
</html>
