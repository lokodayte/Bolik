<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bubble Tea — Live Orders (Elina)</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .done-btn {
      background: #ff4747;
      border: none;
      border-radius: 6px;
      color: white;
      padding: 6px 10px;
      cursor: pointer;
      margin-top: 6px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .tabs button {
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
      background: #ddd;
    }
    .tabs button.active {
      background: #1f7aef;
      color: #fff;
    }
    .delete-all {
      background: #c0392b;
      border: none;
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 8px;
    }
    h4.date-group {
      margin-top: 16px;
      color: #1f7aef;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <h2>Bubble Tea — Orders Dashboard</h2>
    <div>
      <span id="who"></span>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <main class="card">
    <div class="tabs">
      <button id="activeTab" class="active">Active Orders</button>
      <button id="archiveTab">Archive</button>
    </div>

    <section id="totalsSection">
      <h3>Today's totals</h3>
      <p>Cash: <strong id="cashTotal">0</strong> AMD</p>
      <p>Card: <strong id="cardTotal">0</strong> AMD</p>
    </section>

    <hr />

    <section>
      <h3 id="listTitle">Live orders</h3>
      <button id="deleteAllBtn" class="delete-all" style="display:none;">Delete All</button>
      <ul id="ordersList"></ul>
    </section>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>

  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentView = "active";
    let unsubscribeListener = null;
    let totalsCache = { cash: 0, card: 0, count: 0 };

    function renderOrders(snapshot) {
      const list = document.getElementById('ordersList');
      list.innerHTML = '';

      // If active tab: show totals
      if (currentView === "active") {
        let cashTotal = totalsCache.cash;
        let cardTotal = totalsCache.card;
        let countToday = totalsCache.count;
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);

        snapshot.forEach(doc => {
          const o = doc.data();
          const li = document.createElement('li');
          const ts = o.createdAt ? o.createdAt.toDate() : new Date();
          const dateStr = ts.toLocaleString();

          li.innerHTML = `<strong>${o.customer}</strong> — ${o.bubbles}, ${o.syrup}, ${o.tea} — ${o.payment} — ${o.price} AMD<br/>
                          <small>By ${o.createdBy} at ${dateStr}</small>`;
          const btn = document.createElement('button');
          btn.textContent = "Done";
          btn.className = "done-btn";
          btn.onclick = () => markAsDone(doc.id, o);
          li.appendChild(btn);
          list.appendChild(li);

          if (ts >= start && ts < end) {
            countToday++;
            if (o.payment === 'cash') cashTotal += Number(o.price || 0);
            else if (o.payment === 'card') cardTotal += Number(o.price || 0);
          }
        });

        totalsCache = { cash: cashTotal, card: cardTotal, count: countToday };
        document.getElementById('cashTotal').textContent = cashTotal;
        document.getElementById('cardTotal').textContent = cardTotal;
        document.getElementById('countToday').textContent = countToday;
        document.getElementById('moneyToday').textContent = cashTotal + cardTotal;
      }

      // If archive tab: group by date
      if (currentView === "archive") {
        const groups = {};
        snapshot.forEach(doc => {
          const o = doc.data();
          const ts = o.finishedAt ? o.finishedAt.toDate() : new Date();
          const dateLabel = ts.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
          if (!groups[dateLabel]) groups[dateLabel] = [];
          groups[dateLabel].push({ ...o, ts });
        });

        for (const date in groups) {
          const h4 = document.createElement('h4');
          h4.className = "date-group";
          h4.textContent = date;
          list.appendChild(h4);
          groups[date].forEach(o => {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${o.customer}</strong> — ${o.bubbles}, ${o.syrup}, ${o.tea} — ${o.payment} — ${o.price} AMD<br/>
                            <small>By ${o.createdBy} at ${o.ts.toLocaleString()}</small>`;
            list.appendChild(li);
          });
        }
      }
    }

    async function markAsDone(orderId, orderData) {
      try {
        await db.collection('archive').add({
          ...orderData,
          finishedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await db.collection('orders').doc(orderId).delete();
      } catch (err) {
        console.error("Error archiving order:", err);
        alert("⚠️ Could not move order to archive.");
      }
    }

    async function deleteAllArchive() {
      if (!confirm("Are you sure you want to delete ALL archived orders?")) return;
      try {
        const snap = await db.collection('archive').get();
        const batch = db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        alert("✅ All archived orders deleted!");
      } catch (err) {
        alert("⚠️ Failed to delete: " + err.message);
      }
    }

    function listenToCollection() {
      if (unsubscribeListener) unsubscribeListener();
      const collectionName = currentView === "active" ? "orders" : "archive";
      document.getElementById('listTitle').textContent =
        currentView === "active" ? "Live orders" : "Archived orders";
      document.getElementById('deleteAllBtn').style.display =
        currentView === "archive" ? "inline-block" : "none";
      unsubscribeListener = db.collection(collectionName)
        .orderBy('createdAt', 'desc')
        .onSnapshot(renderOrders, err => console.error('listen error', err));
    }

    auth.onAuthStateChanged(user => {
      if (!user) return window.location = "index.html";
      const allowed = ["b.sargsyan@student.uwcdilijan.am","e.mosoian@student.uwcdilijan.am", "m.saad@student.uwcdilijan.am", "u.kubanychbekova@student.uwcdilijan.am"];
      if (!allowed.includes(user.email.toLowerCase())) {
        auth.signOut();
        return window.location = "index.html";
      }
      document.getElementById('who').textContent = user.email;
      listenToCollection();
    });

    document.getElementById('logoutBtn').addEventListener('click', ()=> auth.signOut().then(()=>window.location='index.html'));

    document.getElementById('activeTab').addEventListener('click', () => {
      currentView = "active";
      document.getElementById('activeTab').classList.add("active");
      document.getElementById('archiveTab').classList.remove("active");
      document.getElementById('totalsSection').style.display = "block";
      listenToCollection();
    });

    document.getElementById('archiveTab').addEventListener('click', () => {
      currentView = "archive";
      document.getElementById('archiveTab').classList.add("active");
      document.getElementById('activeTab').classList.remove("active");
      document.getElementById('totalsSection').style.display = "none";
      listenToCollection();
    });

    document.getElementById('deleteAllBtn').addEventListener('click', deleteAllArchive);
  </script>
</body>
</html>
